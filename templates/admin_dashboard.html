{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}

<!-- Enable sound -->
<button onclick="enableSound()" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded">
ðŸ”” Enable Notification Sound
</button>

<audio id="orderSound" src="{{ url_for('static', filename='sounds/new_order.mp3') }}"></audio>

<!-- New order toast -->
<div id="newOrderAlert"
     class="hidden fixed top-6 right-6 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50">
ðŸ”” New Order Received!
</div>

<div class="min-h-screen bg-gray-50">

<header class="bg-amber-700 text-white p-6 flex justify-between">
    <h1 class="text-3xl font-bold">Admin Dashboard</h1>
    <a href="{{ url_for('admin_logout') }}"
       class="bg-white text-amber-700 px-4 py-2 rounded">
        Logout
    </a>
</header>

<div class="max-w-7xl mx-auto p-6">

<!-- ================= STATS ================= -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white p-4 rounded shadow">
        <p class="text-gray-500">Total Orders</p>
        <h2 id="totalOrders" class="text-2xl font-bold">0</h2>
    </div>

    <div class="bg-white p-4 rounded shadow">
        <p class="text-gray-500">Today's Revenue</p>
        <h2 id="todayRevenue" class="text-2xl font-bold text-green-600">â‚¹0.00</h2>
    </div>

    <div class="bg-white p-4 rounded shadow">
        <p class="text-gray-500">Most Sold Item</p>
        <h2 id="popularItem" class="text-xl font-bold text-amber-700">-</h2>
    </div>
</div>

<!-- ================= ORDERS (TODAY ONLY) ================= -->
<div class="bg-white rounded shadow mb-6 overflow-x-auto">
<div class="p-4 border-b bg-amber-50">
    <h2 class="text-lg font-semibold text-amber-700">Today's Orders</h2>
    <p class="text-sm text-gray-600">Showing orders placed on {{ today_date }}</p>
</div>
<table class="min-w-full">
<thead class="bg-gray-100">
<tr>
    <th class="p-3 text-left">Time</th>
    <th class="p-3 text-left">Customer</th>
    <th class="p-3 text-left">Items</th>
    <th class="p-3 text-center">Total</th>
    <th class="p-3 text-center">Payment</th>
    <th class="p-3 text-center">Status</th>
</tr>
</thead>
<tbody id="ordersBody"></tbody>
</table>
</div>

<!-- ================= DAILY SALES REPORT ================= -->
<div class="bg-white rounded shadow p-6">
<div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-semibold">Daily Sales Report</h2>
    <button onclick="loadAllOrders()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
        Load Historical Data
    </button>
</div>
<div id="dailySales" class="space-y-4">
    <p class="text-gray-500 text-center">Click "Load Historical Data" to view sales history</p>
</div>
</div>

</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let lastOrderCount = 0;
let soundEnabled = false;
let historicalDataLoaded = false; // Flag to prevent overwriting historical data

function enableSound() {
    document.getElementById('orderSound').play()
        .then(() => soundEnabled = true);
}

async function pollOrders() {
    const res = await fetch('/admin/orders/live');
    const orders = await res.json();

    if (lastOrderCount && orders.length > lastOrderCount && soundEnabled) {
        document.getElementById('orderSound').play();
        const alert = document.getElementById('newOrderAlert');
        alert.classList.remove('hidden');
        setTimeout(() => alert.classList.add('hidden'), 3000);
    }

    lastOrderCount = orders.length;

    updateStats(orders);
    updateOrdersTable(orders);
    
    // Only update daily sales if historical data is not loaded
    if (!historicalDataLoaded) {
        updateDailySales(orders);
    }
}

function updateStats(orders) {
    document.getElementById('totalOrders').textContent = orders.length;

    const today = new Date().toISOString().split('T')[0];
    let revenue = 0;
    const itemCount = {};

    orders.forEach(o => {
        if (!o.createdAt) return;

        const date = new Date(o.createdAt).toISOString().split('T')[0];

        if (date === today && o.paymentStatus === 'PAID') {
            revenue += o.totalAmount || 0;
        }

        o.items.forEach(i => {
            itemCount[i.name] = (itemCount[i.name] || 0) + i.quantity;
        });
    });

    document.getElementById('todayRevenue').textContent = `â‚¹${revenue.toFixed(2)}`;

    const popular = Object.entries(itemCount).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById('popularItem').textContent =
        popular ? `${popular[0]} (${popular[1]})` : '-';
}

function updateOrdersTable(orders) {
    const tbody = document.getElementById('ordersBody');
    tbody.innerHTML = '';

    if (orders.length === 0) {
        tbody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-8 text-gray-500">
                No orders received today yet
            </td>
        </tr>`;
        return;
    }

    orders.forEach(o => {
        const items = o.items.map(i => `${i.name} Ã— ${i.quantity}`).join(', ');
        
        // Format time
        let timeStr = 'N/A';
        if (o.createdAt) {
            if (o.createdAt.seconds) {
                timeStr = new Date(o.createdAt.seconds * 1000).toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else {
                timeStr = new Date(o.createdAt).toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        const paymentBadge = o.paymentStatus === 'PAID'
            ? `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">PAID</span>`
            : `<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">PENDING</span>`;

        const statusBadge = o.orderStatus === 'OPEN'
            ? `<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">OPEN</span>`
            : `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">DONE</span>`;

        tbody.innerHTML += `
        <tr class="border-t hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-600">${timeStr}</td>
            <td class="px-4 py-3 font-medium">${o.customerName || 'Guest'}</td>
            <td class="px-4 py-3 text-sm">${items}</td>
            <td class="px-4 py-3 text-center font-semibold">â‚¹${(o.totalAmount||0).toFixed(2)}</td>
            <td class="px-4 py-3 text-center">${paymentBadge}</td>
            <td class="px-4 py-3 text-center">${statusBadge}</td>
        </tr>`;
    });
}

function updateDailySales(orders) {
    const daily = {};

    orders.forEach(o => {
        if (!o.createdAt) return;
        const date = new Date(o.createdAt).toDateString();

        if (!daily[date]) {
            daily[date] = { 
                total: 0, 
                orders: 0,
                items: {},
                paidOrders: 0
            };
        }

        daily[date].total += o.totalAmount || 0;
        daily[date].orders += 1;
        
        if (o.paymentStatus === 'PAID') {
            daily[date].paidOrders += 1;
        }

        o.items.forEach(i => {
            daily[date].items[i.name] =
                (daily[date].items[i.name] || 0) + i.quantity;
        });
    });

    const container = document.getElementById('dailySales');
    
    if (Object.keys(daily).length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">No sales data available</p>';
        return;
    }

    // Sort dates by most recent first
    const sortedDates = Object.entries(daily).sort((a, b) => 
        new Date(b[0]) - new Date(a[0])
    );

    container.innerHTML = sortedDates.map(([date, data]) => `
        <div class="border rounded-lg overflow-hidden">
            <div class="bg-gradient-to-r from-amber-100 to-orange-100 p-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-lg">${date}</h3>
                        <p class="text-sm text-gray-600">
                            ${data.orders} orders â€¢ ${data.paidOrders} paid
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-green-600">â‚¹${data.total.toFixed(2)}</p>
                        <p class="text-sm text-gray-600">Revenue</p>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <h4 class="font-medium mb-3 text-gray-700">All Items Sold</h4>
                <div class="space-y-2 max-h-60 overflow-y-auto">
                    ${Object.entries(data.items)
                        .sort((a,b) => b[1] - a[1])
                        .map(([name, qty]) => `
                        <div class="flex justify-between bg-gray-50 px-3 py-2 rounded text-sm hover:bg-gray-100 transition-colors">
                            <span class="text-gray-700 font-medium">${name}</span>
                            <span class="font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded">${qty} sold</span>
                        </div>
                    `).join('')}
                </div>
                ${Object.keys(data.items).length === 0 ? 
                    '<p class="text-gray-500 text-center text-sm">No items sold on this day</p>' : ''}
            </div>
        </div>
    `).join('');
}

// Load all orders for historical data
async function loadAllOrders() {
    try {
        const container = document.getElementById('dailySales');
        container.innerHTML = '<p class="text-center text-gray-500">Loading historical data...</p>';
        
        const res = await fetch('/admin/orders/all');
        const orders = await res.json();
        
        // Set flag to prevent overwriting
        historicalDataLoaded = true;
        
        updateDailySales(orders);
        
        // Add a reset button to go back to today's view
        const resetBtn = `
            <div class="text-center mt-4">
                <button onclick="resetToToday()" class="bg-gray-600 text-white px-4 py-2 rounded text-sm hover:bg-gray-700">
                    Back to Today's Data
                </button>
            </div>
        `;
        container.innerHTML += resetBtn;
        
    } catch (error) {
        console.error('Error loading all orders:', error);
        document.getElementById('dailySales').innerHTML = 
            '<p class="text-center text-red-500">Failed to load historical data</p>';
    }
}

// Reset to today's data
function resetToToday() {
    historicalDataLoaded = false;
    pollOrders();
}

document.addEventListener('DOMContentLoaded', () => {
    pollOrders();
    setInterval(pollOrders, 3000);
});
</script>

<script type="module" src="{{ url_for('static', filename='js/fcm.js') }}"></script>
{% endblock %}
